<html lang="en" dir="ltr" class="inited">
     <div style="border-radius: 4px; border: 2px solid grey;margin: 10px; padding: 10px; width: 200px;">
    <h1>Data to simulate log in details </h1>
     <form>
  <br/>     
  <input type="checkbox" id="vehicle1" name="vehicle1" value="Bike" />
  <label for="vehicle1"> I am an authenticated user with the below details </label><br/><br/>       
  <label for="fname">First name:</label><br/>
  <input type="text" id="fname" name="fname" /><br/>
  <label for="lname">Last name:</label><br/>
  <input type="text" id="lname" name="lname" />
  
  <label for="lname">Kontainers id (not visible):</label><br/>
  <input type="text" id="ktid" name="lname" />
  <label for="lname">Last name:</label><br/>
  <input type="text" id="lname" name="lname" />
</form>
</div>
    
    <script type='text/javascript' src='https://service.force.com/embeddedservice/5.0/esw.min.js'></script>

    <script type='text/javascript'>
    var offlinechat;
    var onLoadFunction = function() {
    buildStyle(); 
    setTimeout(function(){
          var x = document.getElementsByClassName("message");  
          var pngUrl = 'https://service-cview.cs88.force.com/service/resource/1591275544000/chatIcon2?';
          if(x.length == 1){
              var msg = x[0].innerHTML;
              if(msg != null && msg == 'Contact Us' ){
                 offlinechat = true; 
                 pngUrl = 'https://service-cview.cs88.force.com/service/resource/1591310016000/formIcon?';
              }
          } 
          buildStyle(pngUrl );
    }, 1000);

}

   function buildStyle(urlpicture){
        var style = document.createElement('style');
        style.innerHTML = '';
        style.innerHTML = ` .message { display:none;}`;
        style.innerHTML += ` .embeddedServiceHelpButton .embeddedServiceIcon{display:none;} `;
        style.innerHTML += ` .embeddedServiceHelpButton .embeddedServiceIcon::before{display:none;} `;
        style.innerHTML += ` .embeddedServiceHelpButton .helpButton .uiButton { `;
        style.innerHTML += ` border-radius: 50px; min-width: 70px;  height: 70px;  width: 70px; `;
        style.innerHTML += ` background: #ffffff  url(` + urlpicture + `) no-repeat center/contain;background-size: auto;  `   
        style.innerHTML += ` } `;
        style.innerHTML += `.embeddedServiceHelpButton .helpButton .uiButton:focus {outline: 0px solid #ED0404;width: 100%;}`;
        style.innerHTML += `.embeddedServiceHelpButton .helpButton .uiButton:hover {background-color: #ED0404;} `; 
        style.innerHTML += `.embeddedServiceHelpButton .helpButton { position: fixed;height: 77px;bottom: 0;} `; 
        style.innerHTML += `.embeddedServiceHelpButton .helpButton .uiButton { background-color: #ED0404;   font-family: "Arial", sans-serif; }`;
        style.innerHTML +=  `.embeddedServiceHelpButton .helpButton .uiButton:focus {  outline: 1px solid #ED0404; }`;
        document.body.appendChild(style);     
    }


        var getJSON = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'json';
        xhr.onload = function() {
          var status = xhr.status;
          if (status === 200) {
            callback(null, xhr.response);
          } else {
        callback(status, xhr.response);
          }
        };
        xhr.send();
    };
    
    var resourceData;
    function launchJSONLoadPR (url) {
          resolve();
         
          return new Promise(function(resolve, reject) {
          
          var xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.responseType = 'json';
          xhr.onload = function() {
            var status = xhr.status;
            if (status === 200) {
              resourceData = xhr.response;
              sessionStorage.setItem('ember_simple_auth-session', JSON.stringify(resourceData ) );
              console.log('json loaded');
              resolve(xhr.response)
            } else {
             reject(xhr.response);
           }
        };
        
        xhr.send(); 
      });
    }

     var  launchJSONLoad = new Promise(
      function (resolve, reject) {
        getJSON('https://ceva--service.my.salesforce.com/resource/1592355060000/session_storage_sample?',
            function(err, data) {
              if (err !== null) {
                //alert('Something went wrong: ' + err);
                reject(error);
              } else {
                
                
                resolve('success'); 
              }
        });
     
     

    }
    );
    
    var initESW = function(gslbBaseURL) {
        console.log('initESW ');
    
    
        embedded_svc.settings.prepopulatedPrechatFields = {
            KontainersId__c: "c21a564e-0637-11ea-977e-6f6790a577cd",
            FirstName: "Damien",
            LastName: "FERRARO"
        };    
            
         embedded_svc.settings.extraPrechatFormDetails = [{
        "label": "KontainersId",
        "value": "c21a564e-0637-11ea-977e-6f6790a577cd",
        "displayToAgent": true
        }];             
    
        
        embedded_svc.settings.extraPrechatInfo = [{
          "entityFieldMaps": [ {
            "doCreate": false,
            "doFind": true,
            "fieldName": "KontainersId__c",
            "isExactMatch": true,
            "label": "KontainersId"
          },{
            "doCreate": false,
            "doFind": false,
            "fieldName": "FirstName",
            "isExactMatch": true,
            "label": "KontainersId"
          }
          
          ],
          "entityName": "Contact"
        }];    
    
        embedded_svc.settings.displayHelpButton = true; //Or false
        embedded_svc.settings.language = ''; //For example, enter 'en' or 'en-US'

        //embedded_svc.settings.defaultMinimizedText = '...'; //(Defaults to Chat with an Expert)
        //embedded_svc.settings.disabledMinimizedText = '...'; //(Defaults to Agent Offline)

        //embedded_svc.settings.loadingText = ''; //(Defaults to Loading)
        //embedded_svc.settings.storageDomain = 'yourdomain.com'; //(Sets the domain for your deployment so that visitors can navigate subdomains during a chat session)

        // Settings for Chat
        //embedded_svc.settings.directToButtonRouting = function(prechatFormData) {
            // Dynamically changes the button ID based on what the visitor enters in the pre-chat form.
            // Returns a valid button ID.
        //};
        //embedded_svc.settings.prepopulatedPrechatFields = {}; //Sets the auto-population of pre-chat form fields
        //embedded_svc.settings.fallbackRouting = []; //An array of button IDs, user IDs, or userId_buttonId
        //embedded_svc.settings.offlineSupportMinimizedText = '...'; //(Defaults to Contact Us)
        
        
        embedded_svc.addEventHandler("onHelpButtonClick", function(data) {
            console.log('online event handler');
            startSubmitListen();
        });
       
        
    embedded_svc.addEventHandler("onHelpButtonClick", function(data) { 
        
        startFormListen();
    
        console.log('offline event handler');
        /*
        setTimeout(function(){ 
        
        populateFormFields();
        document.getElementById('Phone__c').onchange = function() {
        var phoneInput = document.getElementById("Phone__c");
        var submitButton = document.getElementsByClassName('submitButton')[0];
        if(isPhoneNumberOk(phoneInput)){
            if(document.getElementById("phoneInputErrorArea") === null)
                displayPhoneError(phoneInput);
            submitButton.disabled = true;
        }else{
            hidePhoneError();
            submitButton.disabled = false;
        }
        
        
        } }, 5000); 
        */
    });     
    
        
        embedded_svc.settings.enabledFeatures = ['LiveAgent'];
        embedded_svc.settings.entryFeature = 'LiveAgent';
        embedded_svc.init(
            'https://ceva--service.my.salesforce.com',
            'https://service-cevalogistics.cs88.force.com',
            gslbBaseURL,
            '00D9E0000009GI9',
            'Ceva_Chat_Group',
            {
                baseLiveAgentContentURL: 'https://c.la2-c1cs-fra.salesforceliveagent.com/content',
                deploymentId: '5729E000000CbGK',
                buttonId: '5739E0000008PSe',
                baseLiveAgentURL: 'https://d.la2-c1cs-fra.salesforceliveagent.com/chat',
                eswLiveAgentDevName: 'Ceva_Chat_Group',
                isOfflineSupportEnabled: true
            }
        );
    };
    
    
    var  launchInit = new Promise(
    function (resolve, reject) {
     if (!window.embedded_svc) {
         var s = document.createElement('script');
         s.setAttribute('src', 'https://ceva--service.my.salesforce.com/embeddedservice/5.0/esw.min.js');
         s.onload = function() {
            initESW(null);
        };
        document.body.appendChild(s);
     } else {
         initESW('https://service.force.com');
     }
     resolve('success'); 
     reject(error);

    }
);
 
var launchLoad = function () {
        launchJSONLoadPR('https://ceva--service.my.salesforce.com/resource/1592355060000/session_storage_sample?') 
        .then(function (fulfilled) {
            launchInit;
        })
        .then(function (fulfilled) {
            onLoadFunction();
        })       
        .catch(function (error) {
            console.log(error.message);
        });
};
launchLoad();
document.cookie ="debug_logs=debug_logs;domain=.force.com";

 
 
</script>
 <script type='text/javascript'>
var submitInterval;
var formInterval;

function startSubmitListen(){
    submitInterval = setInterval(doSubmit, 50);
    setTimeout(function(){ 
        clearInterval(submitInterval);
    }, 2000);

}

 function doSubmit(){
         var btnSubmit = document.getElementsByClassName("startButton");
        console.log('doSubmit' + btnSubmit);
        if(btnSubmit.length  > 0){
            clearInterval(submitInterval);
            btnSubmit[0].click();
        }          
}


function startFormListen(){
 formInterval = setInterval(doForm, 200);
    setTimeout(function(){ 
        clearInterval(formInterval);
    }, 4000);

}

function doForm(){
        var phoneField = document.getElementById('Phone__c');
        console.log('do form');
        if(phoneField  != null){
            populateFormFields();
            document.getElementById('Phone__c').onchange = function() {
            var phoneInput = document.getElementById("Phone__c");
            var submitButton = document.getElementsByClassName('submitButton')[0];
            if(isPhoneNumberOk(phoneInput)){
                if(document.getElementById("phoneInputErrorArea") === null)
                    displayPhoneError(phoneInput);
                submitButton.disabled = true;
            }else{
                hidePhoneError();
                submitButton.disabled = false;
            }
        
        
           } 
           clearInterval(formInterval); 
        }
                        
}



function displayPhoneError(phoneInput){
    var errorTag = '<ul class="has-error uiInputDefaultError uiInput uiInputText uiInput--default uiInput--input" id="phoneInputErrorArea"   data-aura-class="uiInputDefaultError uiInput uiInputText uiInput--default uiInput--input">';
    errorTag += '<li class="form-element__help" >';
    errorTag += 'Please enter a valid phone number.';
    errorTag += '</li></ul>';
    var parentDiv = phoneInput.parentElement;
    parentDiv.insertAdjacentHTML('afterend', errorTag);
}
function hidePhoneError(){
    if(document.getElementById("phoneInputErrorArea") !== null)
        document.getElementById("phoneInputErrorArea").remove();
}
function isPhoneNumberOk(inputPhone){
    var phoneRE = /^\+?([0-9]{2})\)?[-. ]?([0-9]{4})[-. ]?([0-9]{4})$/;
    if(inputPhone.value.match(phoneRE)){
       return false;   
    }else{
        return true;
    }
}


function populateFormFields(){
    var sessiondata = JSON.parse(sessionStorage.getItem('ember_simple_auth-session'));
    console.log('sessionStorage ' + sessiondata );
    
    var event = new Event('change');
    document.getElementById('Last_Name__c').value = sessiondata.authenticated.lastName;
    
     document.getElementById('Last_Name__c').dispatchEvent(event);
    document.getElementById('First_Name__c').value = sessiondata.authenticated.firstName;
    document.getElementById('Email__c').value = sessiondata.authenticated.email;
    document.getElementById('Phone__c').value = sessiondata.authenticated.company.companyAddress.phone;
    document.getElementById('Company__c').value = sessiondata.authenticated.company.name;    
    document.getElementById('Contact_Country__c').value = sessiondata.authenticated.company.companyAddress.country;
    document.getElementById('ContactKontainersId__c').value = sessiondata.authenticated.id;
    document.getElementById('ContactKontainersId__c').parentNode.style.display = "none";
    
    document.getElementById('Contact_Country__c').dispatchEvent(event);
    document.getElementById('First_Name__c').dispatchEvent(event);
    document.getElementById('Email__c').dispatchEvent(event);
    document.getElementById('Phone__c').dispatchEvent(event);
    document.getElementById('Company__c').dispatchEvent(event);
    
    document.getElementById('Contact_Country__c').disabled = true;
    document.getElementById('Last_Name__c').disabled = true;
    document.getElementById('First_Name__c').disabled = true;
    document.getElementById('Email__c').disabled = true;
    document.getElementById('Phone__c').disabled = true; 
    document.getElementById('Company__c').disabled = true; 
     
    
    
    }
</script>
</html>
